# ==============================================================================
# StorageClass for Google Filestore (NFS Protocol)
# ==============================================================================
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: filestore-nfs-sc
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
provisioner: kubernetes.io/no-provisioner
reclaimPolicy: Retain
volumeBindingMode: Immediate
allowVolumeExpansion: false
---
# ==============================================================================
# Static PersistentVolume - Existing Filestore NFS Share
# ==============================================================================
apiVersion: v1
kind: PersistentVolume
metadata:
  name: filestore-nfs-pv
spec:
  capacity:
    storage: 100Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: filestore-nfs-sc
  mountOptions:
    - nconnect=8
    - hard
    - timeo=600
    - retrans=2
  nfs:
    # Filestore exports a single NFS path: /${filestore_share}
    server: ${filestore_ip}          # e.g. 10.0.0.50
    path: /${filestore_share}        # e.g. /rstudio-share
---
# ==============================================================================
# PersistentVolumeClaim for Filestore NFS PV
# ==============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: filestore-nfs-pvc
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: filestore-nfs-sc
  volumeName: filestore-nfs-pv
  resources:
    requests:
      storage: 100Gi
---
# --- Secret: RStudio Configuration -------------------------------------------
apiVersion: v1
kind: Secret
metadata:
  name: rstudio-config
type: Opaque
stringData:
  admin_secret: "admin-ad-credentials"
  domain_fqdn: "rstudio.mikecloud.com"
  netbios: "RSTUDIO"

# Notes:
# - Values are low sensitivity; real credentials live in an external vault
#   (for GKE, typically Secret Manager or similar).
# - Mounted as text files inside the container (not environment variables).
---
# --- Headless Service for StatefulSet ----------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: rstudio
  labels:
    app: rstudio
spec:
  clusterIP: None
  selector:
    app: rstudio
  ports:
    - port: 8787
      name: rstudio
# Notes:
# - Enables hostnames like rstudio-0.rstudio.<namespace>.svc.
# - Required for StatefulSet hostname stability and AD compatibility.
---
# ==============================================================================
# StatefulSet for RStudio Server Cluster on GKE
# ==============================================================================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rstudio
  labels:
    app: rstudio
spec:
  serviceName: "rstudio"
  replicas: 2
  selector:
    matchLabels:
      app: rstudio
  template:
    metadata:
      labels:
        app: rstudio
      # Add GKE Workload Identity annotation here if you want:
      # annotations:
      #   iam.gke.io/gcp-service-account: "rstudio-sa@${project_id}.iam.gserviceaccount.com"
    spec:
      # ----------------------------------------------------------------------
      # Node/Pod Placement Rules
      # ----------------------------------------------------------------------
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - rstudio
              topologyKey: "kubernetes.io/hostname"

      # ----------------------------------------------------------------------
      # Service Account
      # ----------------------------------------------------------------------
      serviceAccountName: rstudio-sa

      # ----------------------------------------------------------------------
      # Containers
      # ----------------------------------------------------------------------
      containers:
      - name: rstudio
        image: ${rstudio_image}
        ports:
        - containerPort: 8787
        resources:
          requests:
            cpu: "500m"
            memory: "500Mi"
          limits:
            cpu: "2000m"
            memory: "3000Mi"
        readinessProbe:
          httpGet:
            path: /auth-sign-in
            port: 8787
        livenessProbe:
          httpGet:
            path: /auth-sign-in
            port: 8787
        volumeMounts:
        - name: rstudio-config-vol
          mountPath: /etc/rstudio-config
        - name: filestore-nfs-storage
          mountPath: /nfs          # maps to Filestore root: /${filestore_share}
        - name: filestore-nfs-storage
          mountPath: /home         # maps to /${filestore_share}/home
          subPath: home

      # ----------------------------------------------------------------------
      # Volumes
      # ----------------------------------------------------------------------
      volumes:
        - name: rstudio-config-vol
          secret:
            secretName: rstudio-config
        - name: filestore-nfs-storage
          persistentVolumeClaim:
            claimName: filestore-nfs-pvc
---
# --- ClusterIP Service for External Access -----------------------------------
apiVersion: v1
kind: Service
metadata:
  name: rstudio-external
  labels:
    app: rstudio
spec:
  selector:
    app: rstudio
  ports:
    - port: 8787
      targetPort: 8787
      name: rstudio
---
# ==============================================================================
# Ingress Resource for RStudio Server (nginx Ingress Controller)
# ==============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rstudio-ingress
  annotations:
    # --- Enable Sticky Sessions ----------------------------------------------
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/session-cookie-name: "rstudio_session"
    nginx.ingress.kubernetes.io/session-cookie-hash: "sha1"
    nginx.ingress.kubernetes.io/session-cookie-path: "/"

    # --- Backend Protocol (HTTP) ---------------------------------------------
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/rewrite-target: "/"
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: rstudio-external
                port:
                  number: 8787
---
# --- Horizontal Pod Autoscaler (CPU-Based Scaling) ---------------------------
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: rstudio-hpa
  labels:
    app: rstudio
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: rstudio
  minReplicas: 2
  maxReplicas: 4
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
# Notes:
# - HPA scales between 2â€“4 replicas based on CPU utilization.
# - Cluster Autoscaler handles node provisioning on GKE.
# - StatefulSet preserves stable hostnames for AD integration.
